package me.struttle.plugins.events;

import org.bukkit.ChatColor;
import org.bukkit.entity.Player;
import org.bukkit.event.EventHandler;
import org.bukkit.event.Listener;
import org.bukkit.event.player.PlayerCommandPreprocessEvent;
import org.bukkit.event.player.PlayerJoinEvent;
import org.bukkit.event.player.PlayerQuitEvent;
import org.bukkit.event.player.PlayerRespawnEvent;
import org.bukkit.event.player.PlayerTeleportEvent;

public class PlayerListener implements Listener{
	Events m_Plugin = null;
	public PlayerListener()
	{
		m_Plugin = Events.GetInstance();
	}
	
	@EventHandler
    public void OnPlayerCommand(PlayerCommandPreprocessEvent event) {
        Player player = event.getPlayer();
        if(m_Plugin.IsInEvent(player) && !event.getMessage().equalsIgnoreCase("/spawn") && !player.hasPermission("events.bypass.blockcommands"))
        {
        	player.sendMessage(ChatColor.DARK_RED + "You are not allowed to use that command during an event");
        	event.setCancelled(true);
        }
    }
	
	@EventHandler
    public void OnPlayerTeleport(PlayerTeleportEvent event) {
        Player player = event.getPlayer();
        m_Plugin.LeaveEvent(player);
    }
	
	@EventHandler
	public void OnPlayerDeath(PlayerRespawnEvent event)
	{
		Player player = event.getPlayer();
		m_Plugin.LeaveEvent(player);
	}
	
	@EventHandler
	public void OnPlayerDisconnect(PlayerQuitEvent event)
	{
		Player player = event.getPlayer();
		m_Plugin.m_PlayersToSendToSpawn.add(player.getUniqueId());
		m_Plugin.GetConfig().SavePlayersToSendToSpawn(m_Plugin.m_PlayersToSendToSpawn);
		m_Plugin.LeaveEvent(player);
	}
	
	@EventHandler
	public void OnPlayerJoin(PlayerJoinEvent event)
	{
		Player player = event.getPlayer();
		if(m_Plugin.m_PlayersToSendToSpawn.contains(player.getUniqueId()))
		{
			player.teleport(player.getWorld().getSpawnLocation());
		}
	}
}
